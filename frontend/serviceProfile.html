<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Profile</title>
    <link rel="icon" href="/img/profile.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --subtext-color: #666;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            background-image: url(/img/loginpage.jpg);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-color);
            font-weight: 700;
        }

        /* 3-Column Layout */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 Columns on Desktop */
            gap: 25px;
        }

        /* Common Column Styles */
        .col {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Column 1: Basic Info */
        .col-1 {
            align-items: center;
            text-align: center;
        }

        #serviceIconDisplay {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        /* Info Item Styles (Icon + Text) */
        .info-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 5px;
            gap: 10px;
            min-height: 40px;
        }

        .info-item i {
            width: 30px;
            min-width: 30px;
            color: var(--primary-color);
            font-size: 1.1rem;
            text-align: center;
            flex-shrink: 0;
        }

        .info-text {
            font-size: 0.95rem;
            color: var(--text-color);
            word-break: break-word;
            text-align: left;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #viewPriceLink {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .edit-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            display: none; 
            margin-bottom: 5px;
        }

        /* Section Headers */
        h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
            width: 100%;
        }

        /* Buttons */
        .btn-container {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-edit {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
            display: none; /* Hidden initially */
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Checkbox Grid */
        .checkbox-container {
             display: flex;
             flex-direction: column;
             gap: 8px;
        }
        
        /* Responsive Breakpoints */
        @media (max-width: 1024px) {
            .profile-grid {
                grid-template-columns: 1fr 1fr; /* 2 Columns on Tablets */
            }
            .col-1 {
                grid-column: 1 / -1; 
                flex-direction: row;
                justify-content: space-around;
                text-align: left;
            }
            #serviceIconDisplay {
                margin-right: 20px;
                margin-bottom: 0;
                 width: 100px;
                height: 100px;
            }
        }

        @media (max-width: 768px) {
            .profile-grid {
                display: flex;
                flex-direction: column; /* Stack on Mobile */
            }
            .col-1 {
                flex-direction: column;
                text-align: center;
            }
            #serviceIconDisplay {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }
        
        /* Edit Mode */
        .edit-mode .info-text,
        .edit-mode .view-section {
            display: none;
        }
        
        .edit-mode .edit-input,
        .edit-mode .btn-save,
        .edit-mode .dynamic-edit-container {
            display: block;
            width: 100%;
        }
        
        .edit-mode .btn-edit {
            display: none;
        }
        
        /* View Mode */
         .view-mode .edit-input, 
         .view-mode .dynamic-edit-container {
             display: none;
         }

    </style>
</head>
<body class="view-mode"> 

    <div class="container">
        <h1>Service Profile</h1>
        
        <form id="profileForm" class="profile-grid">
            
            <!-- COLUMN 1: Basic Biz Info -->
            <div class="col col-1">
                <img src="/img/service.png" id="serviceIconDisplay" alt="Service Icon">
                
                <div class="info-group" style="width: 100%;">
                    <!-- Business Name -->
                    <div class="info-item">
                        <i class="fas fa-building"></i>
                        <span class="info-text" id="viewBusinessName">Loading...</span>
                        <input type="text" class="edit-input" id="editBusinessName" name="businessName" placeholder="Business Name">
                    </div>

                    <!-- Email -->
                    <div class="info-item">
                        <i class="fas fa-envelope"></i>
                        <span class="info-text" id="viewEmail">Loading...</span>
                        <input type="email" class="edit-input" id="editEmail" name="email" placeholder="Email" disabled title="Email cannot be changed">
                    </div>

                    <!-- Contact -->
                    <div class="info-item">
                        <i class="fas fa-phone"></i>
                        <span class="info-text" id="viewContact">Loading...</span>
                        <input type="tel" class="edit-input" id="editContact" name="contactNumber" placeholder="Contact Number">
                    </div>
                    
                    <!-- Address -->
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="info-text" id="viewAddress">Loading...</span>
                        <input type="text" class="edit-input" id="editAddress" name="address" placeholder="Address">
                    </div>

                     <!-- Password (Edit Only) -->
                     <input type="password" class="edit-input" id="editPassword" name="password" placeholder="Update Password (Optional)">
                </div>
            </div>

            <!-- COLUMN 2: Details -->
            <div class="col col-2">
                <h3>Service Details</h3>
                
                <!-- Service Type -->
                <div class="info-item">
                    <i class="fas fa-briefcase"></i>
                    <span class="info-text" id="viewServiceType">Service Type</span>
                    <select class="edit-input" id="editService" name="service" onchange="updateIcon(this.value); updateDynamicFields(this.value)">
                        <option value="Food">Food Service</option>
                        <option value="Laundry">Laundry Service</option>
                        <option value="Broker">Broker / PG</option>
                    </select>
                </div>
                
                 <!-- Price Chart -->
                <div class="info-item">
                    <i class="fas fa-tag"></i>
                    <a href="#" target="_blank" class="info-text" id="viewPriceLink" style="color: var(--primary-color); text-decoration: underline;">View Price Chart</a>
                    <input type="url" class="edit-input" id="editPriceLink" name="priceChartLink" placeholder="Price Chart URL">
                </div>

            </div>

             <!-- COLUMN 3: Dynamic Config -->
            <div class="col col-3">
                <h3>Service Configuration</h3>
                
                <!-- View Mode: Dynamic Content -->
                <div id="viewDynamicContent" class="view-section">
                </div>

                <!-- Edit Mode: Dynamic Fields -->
                <div id="editDynamicContainer" class="dynamic-edit-container">
                    <!-- JS Populates this -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="btn-container">
                <button type="button" class="btn btn-edit" onclick="toggleEditMode(true)">Edit Profile</button>
                <button type="button" class="btn btn-save" onclick="saveProfile()">Save Changes</button>
            </div>
        </form>
    </div>

    <script>
        let serviceData = {};
        let extraFields = {};

        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Parse backend data
                serviceData = {
                    business_Name: '{{businessName}}',
                    email: '{{email}}',
                    contact_number: '{{contactNumber}}',
                    address: '{{address}}',
                    service: '{{service}}',
                    password: '{{password}}',
                    price_chart_link: '{{priceChartLink}}',
                    extraFields: '{{extraFields}}'
                };

                // Parse extra fields JSON
                if (serviceData.extraFields && serviceData.extraFields !== "undefined") {
                     extraFields = JSON.parse(serviceData.extraFields.replace(/&quot;/g,'"'));
                }
            } catch (e) {
                console.error("Error parsing serviceData", e);
                // Mock data for UI testing if backend var fails
                serviceData = {
                    business_Name: "My Business",
                    service: "Food"
                };
            }

            populateView();
            populateForm();
            updateIcon(serviceData.service);
            updateDynamicFields(serviceData.service); // Setup form fields
        });

        function updateIcon(type) {
            const img = document.getElementById('serviceIconDisplay');
            if(type === 'Food') img.src = '/img/foodservice.jpg';
            else if(type === 'Laundry') img.src = '/img/laundryservice.jpg';
            else if(type === 'Broker') img.src = '/img/brokerservice.jpg';
            else img.src = '/img/service.png';
        }

        function populateView() {
            document.getElementById('viewBusinessName').textContent = serviceData.business_Name || 'Not Set';
            document.getElementById('viewEmail').textContent = serviceData.email || 'Not Set';
            document.getElementById('viewContact').textContent = serviceData.contact_number || 'Not Set';
            document.getElementById('viewAddress').textContent = serviceData.address || 'Not Set';
            document.getElementById('viewServiceType').textContent = serviceData.service || 'Select Service';
            
            const pLink = document.getElementById('viewPriceLink');
            if(serviceData.price_chart_link) {
                pLink.href = serviceData.price_chart_link;
                pLink.textContent = "View Price Chart";
                pLink.style.display = 'block';
            } else {
                pLink.style.display = 'none';
            }

            // Populate Dynamic View
            const container = document.getElementById('viewDynamicContent');
            container.innerHTML = '';
            
            if(serviceData.service === 'Food') {
                 container.innerHTML += `<div class="info-item"><i class="fas fa-utensils"></i> ${extraFields.food_type || 'Not specified'}</div>`;
            } else if (serviceData.service === 'Laundry') {
                 container.innerHTML += `<strong>Services:</strong><br>${(extraFields.laundry_service || '').split(',').join('<br>')}`;
            } else if (serviceData.service === 'Broker') {
                 container.innerHTML += `
                    <div class="info-item"><i class="fas fa-home"></i> ${extraFields.room_type || '-'}</div>
                    <div class="info-item"><i class="fas fa-rupee-sign"></i> ${extraFields.pricing_value || '-'}</div>
                    <div class="info-item"><i class="fas fa-check-circle"></i> ${extraFields.availability || '-'}</div>
                    <hr>
                    <strong>Amenities:</strong> <small>${(extraFields.amenities || []).join(', ')}</small><br>
                    <strong>Landmarks:</strong> <small>${(extraFields.landmark || []).join(', ')}</small>
                 `;
            }
        }

        function populateForm() {
            document.getElementById('editBusinessName').value = serviceData.business_Name || '';
            document.getElementById('editEmail').value = serviceData.email || '';
            document.getElementById('editContact').value = serviceData.contact_number || '';
            document.getElementById('editAddress').value = serviceData.address || '';
            document.getElementById('editPassword').value = serviceData.password || '';
            document.getElementById('editService').value = serviceData.service || 'Food';
            document.getElementById('editPriceLink').value = serviceData.price_chart_link || '';
        }

        // Logic to build dynamic form fields based on Service Type
        function updateDynamicFields(type) {
            const container = document.getElementById('editDynamicContainer');
            container.innerHTML = ''; // Clear

            if (type === 'Food') {
                createSelect(container, 'food_type', 'Food Type', ['Veg', 'Non-Veg', 'All'], extraFields.food_type);
            } 
            else if (type === 'Laundry') {
                createCheckboxGroup(container, 'laundry_service', 'Services Offered', 
                    ['Wash & Iron', 'Dry Cleaning', 'Pickup & Delivery', 'Subscription Plans'], 
                    (extraFields.laundry_service || '').split(','));
            } 
            else if (type === 'Broker') {
                createSelect(container, 'room_type', 'Room Type', ['Single', 'Shared', 'Apartment'], extraFields.room_type);
                createSelect(container, 'pricing_value', 'Price Range', ['Low', 'Medium', 'High'], extraFields.pricing_value);
                createSelect(container, 'availability', 'Availability', ['Available', 'Not Available'], extraFields.availability);
                
                createCheckboxGroup(container, 'amenities', 'Amenities', 
                    ['WiFi', 'Non-AC', 'AC', 'TV', 'Furnished', 'Parking'], extraFields.amenities || []);
                    
                createCheckboxGroup(container, 'landmark', 'Landmarks', 
                    ['Near Bus Station', 'Near Railway Station', 'Near Metro', 'Near Market', 'Near College'], extraFields.landmark || []);
            }
        }

        // Helpers for Dynamic Form
        function createSelect(parent, name, label, options, selected) {
            let html = `<label>${label}</label><select class="edit-input" id="${name}" name="${name}">`;
            options.forEach(opt => {
                html += `<option value="${opt}" ${selected === opt ? 'selected' : ''}>${opt}</option>`;
            });
            html += `</select>`;
            parent.innerHTML += html;
        }

        function createCheckboxGroup(parent, name, label, options, checkedList) {
             let html = `<label><strong>${label}</strong></label><div class="checkbox-container">`;
             options.forEach(opt => {
                 const isChecked = checkedList.includes(opt) ? 'checked' : '';
                 html += `<label><input type="checkbox" name="${name}" value="${opt}" ${isChecked}> ${opt}</label>`;
             });
             html += `</div><br>`;
             parent.innerHTML += html;
        }

        function toggleEditMode(enable) {
            const body = document.body;
            if (enable) {
                body.classList.remove('view-mode');
                body.classList.add('edit-mode');
                // Re-inject dynamic form fields in case service type changed
                 updateDynamicFields(document.getElementById('editService').value);
            } else {
                body.classList.remove('edit-mode');
                body.classList.add('view-mode');
            }
        }

        async function saveProfile() {
            const form = document.getElementById('profileForm');
            const formData = new FormData();

            // Static Fields
            formData.append('businessName', document.getElementById('editBusinessName').value);
            formData.append('email', document.getElementById('editEmail').value);
            formData.append('contactNumber', document.getElementById('editContact').value);
            formData.append('address', document.getElementById('editAddress').value);
            formData.append('password', document.getElementById('editPassword').value);
            formData.append('service', document.getElementById('editService').value);
            formData.append('priceChartLink', document.getElementById('editPriceLink').value);

            // Dynamic Extra Fields Logic
            const serviceType = document.getElementById('editService').value;
            const updatedExtras = {};

            if(serviceType === 'Food') {
                updatedExtras.food_type = document.getElementById('food_type').value;
            } else if (serviceType === 'Laundry') {
                 updatedExtras.laundry_service = Array.from(document.querySelectorAll('input[name="laundry_service"]:checked'))
                    .map(el => el.value).join(',');
            } else if (serviceType === 'Broker') {
                updatedExtras.room_type = document.getElementById('room_type').value;
                 updatedExtras.pricing_value = document.getElementById('pricing_value').value;
                 updatedExtras.availability = document.getElementById('availability').value;
                 updatedExtras.amenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(el => el.value);
                 updatedExtras.landmark = Array.from(document.querySelectorAll('input[name="landmark"]:checked')).map(el => el.value);
            }
            
            formData.append('extra_fields', JSON.stringify(updatedExtras));

            try {
                const res = await fetch('/profile-update', { method: 'POST', body: formData });
                if(res.ok) {
                    alert('Profile updated!');
                    location.reload();
                } else {
                    alert('Update failed');
                }
            } catch (e) {
                console.error(e);
                alert('Error saving profile');
            }
        }
    </script>
</body>
</html>