<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="icon" href="/img/profile.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Calistoga&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    width: 100%;
    background-image: url(/img/loginpage.jpg);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.profile-class {
    background-color: snow;
    font-family: 'Arial', sans-serif;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 800px;
    display: flex;
    flex-wrap: wrap;
    height: auto;
    justify-content: space-between;
    position: relative;
    top: 50%;
    left: 50%;
    transform: translateX(-50%);
}

h1 {
    color: black;
    text-align: center;
    margin-top: 50px;
}

.profile-class label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.profile-class input,
.profile-class select {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    transition: border 0.3s ease, box-shadow 0.3s ease;
}

.profile-class input:focus,
.profile-class select:focus {
    border: 1px solid #f39c12;
    box-shadow: 0 0 8px rgba(243, 156, 18, 0.5);
}

.password-container {
    position: relative;
    width: 100%;
}

#togglePassword {
    position: absolute;
    top: 40%;
    right: 10px;
    transform: translateY(-50%);
    color: #D0B8A8;
    cursor: pointer;
}

.profile-class button {
    width: 48%;
    padding: 10px;
    border: none;
    background-color: #007bff;
    color: white;
    border-radius: 15px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.3s ease;
    margin-top: 10px;
}

.profile-class button:hover {
    background-color: #0056b3;
    transform: scale(1.05);
}

.container-1, .container-2 {
    flex: 1;
    padding: 25px;
    min-width: 300px;
}

.container-2 label,
.container-2 input,
.container-2 select {
    position: relative;
    top: 0;
    right: 0;
}

.button-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    width: 100%;
    margin-top: 80px;
    margin-left: -200px;
}

#saveBtn, #editBtn {
    width: auto;
    min-width: 200px;
}

/* Responsive Design */
@media (max-width: 900px) {
    .profile-class {
        width: 90%;
        flex-direction: column;
        align-items: center;
        padding: 15px;
    }

    .container-2 {
        padding-left: 10px;
        padding-right: 10px;
        top: 0;
        right: 0;
    }

    .container-2 label,
    .container-2 input,
    .container-2 select {
        top: 0;
        right: 0;
    }

    .button-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    #saveBtn, #editBtn {
        width: 100%;
    }
}
.checkbox-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 5px;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

.checkbox-wrapper input[type="checkbox"] {
    width: 14px;
    height: 14px;
    cursor: pointer;
}

.checkbox-wrapper label {
    font-size: 14px;
    cursor: pointer;
}
</style>
</head>
<body>
<h1>Edit Business</h1>
<div class="profile-class">
    <div class="container-1">
        <form id="profileForm1">
            <div class="form-group">
                <label for="businessName">Business name:</label>
                <input type="text" id="businessName" name="businessName" placeholder="Enter business name" required disabled>
            </div>
            <div class="form-group">
                <label for="email">Email address:</label>
                <input type="email" placeholder="Enter your Email" id="email" name="email" required disabled>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <div class="password-container">
                    <input type="password" id="password" name="password" placeholder="Enter Your Password" required disabled>
                    <i class="fas fa-eye" id="togglePassword"></i>
                </div>
            </div>
            <div class="form-group">
                <label for="address">Business Address:</label>
                <input type="text" placeholder="Enter your business address" id="address" name="address" required disabled>
            </div>
        </form>
    </div>

    <div class="container-2">
        <form id="profileForm2">
            <div class="form-group">
                <label for="contactNumber">Contact number:</label>
                <input type="tel" placeholder="Enter your contact number" id="contactNumber" name="contactNumber" required disabled>
            </div>

            <div class="form-group">
                <label for="service">Select Service type:</label>
                <select id="service" name="service" required disabled>
                    <option value="" disabled selected>Select Service</option>
                    <option value="Food">Food</option>
                    <option value="Laundry">Laundry</option>
                    <option value="Broker">Broker</option>
                </select>
                <div id="extra-fields"></div>
            </div>

            <div class="form-group">
                <label for="priceChartLink">Price Chart Link:</label>
                <input type="url" id="priceChartLink" name="priceChartLink" disabled>
            </div>
            <div class="button-container">
                <button type="button" id="editBtn">Edit</button>
                <button type="button" id="saveBtn">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const serviceData = {
        business_Name: '{{businessName}}',
        email: '{{email}}',
        address: '{{address}}',
        contact_number: '{{contactNumber}}',
        service: '{{service}}',
        password: '{{password}}',
        price_chart_link: '{{priceChartLink}}',
        extraFields: '{{extraFields}}' // Expecting a JSON string with relevant fields
    };

    // Log the raw extraFields value for debugging
    console.log('Raw extraFields:', serviceData.extraFields);

    // Populate the fields
    document.getElementById('businessName').value = serviceData.business_Name || '';
    document.getElementById('email').value = serviceData.email || '';
    document.getElementById('address').value = serviceData.address || '';
    document.getElementById('contactNumber').value = serviceData.contact_number || '';
    document.getElementById('service').value = serviceData.service || '';
    document.getElementById('password').value = serviceData.password || '';
    document.getElementById('priceChartLink').value = serviceData.price_chart_link || '';

    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const profileForm1 = document.getElementById('profileForm1');
    const profileForm2 = document.getElementById('profileForm2');
    const serviceSelect = document.getElementById('service');
    const extraFieldsContainer = document.getElementById('extra-fields');

    // Safely parse extraFields with error handling
    let extraFields = {};
    if (serviceData.extraFields) {
        try {
            extraFields = JSON.parse(serviceData.extraFields);
        } catch (e) {
            console.error('Error parsing extraFields:', e);
            console.log('Using empty object as fallback');
            extraFields = {};
        }
    }

    // Populate extra fields on page load based on the current service
    populateExtraFields(serviceData.service, extraFields);

    editBtn.addEventListener('click', function () {
        console.log('Edit button clicked');
        // Enable all fields in both forms
        Array.from(profileForm1.elements).forEach(el => {
            el.disabled = false;
            console.log(`${el.name} enabled`);
        });
        Array.from(profileForm2.elements).forEach(el => {
            el.disabled = false;
            console.log(`${el.name} enabled`);
        });
        // Enable dynamically added fields in extra-fields
        Array.from(extraFieldsContainer.querySelectorAll('input, select')).forEach(el => {
            el.disabled = false;
            console.log(`Extra field ${el.name || el.id} enabled`);
        });
    });

    saveBtn.addEventListener('click', function () {
        console.log('Save button clicked');
        const formData = new FormData();

        // Add fields from both forms
        Array.from(profileForm1.elements).forEach(el => {
            if (el.name) formData.append(el.name, el.value);
        });
        Array.from(profileForm2.elements).forEach(el => {
            if (el.name && el.type !== 'checkbox') formData.append(el.name, el.value);
        });

        // Collect updated extra fields based on the current service
        const updatedExtraFields = {};
        if (serviceSelect.value === 'Food') {
            updatedExtraFields.food_type = document.getElementById('food_type')?.value || '';
        } else if (serviceSelect.value === 'Laundry') {
            updatedExtraFields.laundry_service = document.getElementById('laundry_service')?.value || '';
        } else if (serviceSelect.value === 'Broker') {
            updatedExtraFields.room_type = document.getElementById('room_type')?.value || '';
            updatedExtraFields.amenities = Array.from(document.querySelectorAll('input[name="amenities[]"]:checked'))
                .map(cb => cb.value);
            updatedExtraFields.pricing_value = document.getElementById('pricing_value')?.value || '';
            updatedExtraFields.landmark = Array.from(document.querySelectorAll('input[name="landmark[]"]:checked'))
                .map(cb => cb.value);
            updatedExtraFields.availability = document.getElementById('availability')?.value || '';
        }

        formData.append('extra_fields', JSON.stringify(updatedExtraFields));

        // Log form data for debugging
        console.log('Form Data:', [...formData]);

        // Send data to the server
        fetch('/profile-update', {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            return response.text();
        })
        .then(data => {
            console.log('Server Response:', data);
            if (data === 'Profile updated successfully') {
                alert('Profile updated successfully!');
                // Disable all fields after saving
                Array.from(profileForm1.elements).forEach(el => el.disabled = true);
                Array.from(profileForm2.elements).forEach(el => el.disabled = true);
                Array.from(extraFieldsContainer.querySelectorAll('input, select')).forEach(el => el.disabled = true);
            } else {
                alert('Failed to update profile: ' + data);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('Error saving profile. Check the console for details.');
        });
    });

    serviceSelect.addEventListener('change', function () {
        extraFieldsContainer.innerHTML = ''; // Clear previous fields
        populateExtraFields(serviceSelect.value, {});
    });

    function populateExtraFields(serviceType, existingData) {
        if (serviceType === 'Food') {
            createDropdown(extraFieldsContainer, 'food_type', 'Select Food Type you offer:', 
                ['Veg', 'Non-Veg', 'All → Veg, Non-Veg, Jain meal, Chinese'], existingData.food_type);
        } else if (serviceType === 'Laundry') {
            createDropdown(extraFieldsContainer, 'laundry_service', 'Select Laundry Services you offer:', 
                ['Wash & Iron', 'Dry Cleaning', 'Pickup & Delivery Service', 'Subscription Plans', 'Express Service'], 
                existingData.laundry_service);
        } else if (serviceType === 'Broker') {
            createDropdown(extraFieldsContainer, 'room_type', 'Select available Room Types:', 
                ['Single', 'Shared', 'Apartment'], existingData.room_type);
            createCheckboxGroup(extraFieldsContainer, 'amenities', 'Select Amenities available in your PGs:', 
                ['Furnished', 'Parking', 'AC', 'Non-AC', 'WiFi', 'TV'], existingData.amenities || []);
            createDropdown(extraFieldsContainer, 'pricing_value', 'Select pricing value of PGs:', 
                ['Low: ₹5000 - 8000', 'Medium: ₹8000 - 100000', 'High: ₹10000 - 15000'], existingData.pricing_value);
            createCheckboxGroup(extraFieldsContainer, 'landmark', 'Select available PGs Landmark:', 
                ['Near Railway Station', 'Near Market', 'Near Metro', 'Near College', 'Near Bus Station'], existingData.landmark || []);
            createDropdown(extraFieldsContainer, 'availability', 'Select Availability of Rooms:', 
                ['Available', 'Not Available'], existingData.availability);
        }
    }

    function createDropdown(container, id, label, options, selectedValue) {
        const labelElement = document.createElement('label');
        labelElement.htmlFor = id;
        labelElement.textContent = label;

        const selectElement = document.createElement('select');
        selectElement.id = id;
        selectElement.name = id;
        selectElement.required = true;
        selectElement.disabled = true; // Initially disabled

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Please select';
        defaultOption.disabled = true;
        selectElement.appendChild(defaultOption);

        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            if (option === selectedValue) optionElement.selected = true;
            selectElement.appendChild(optionElement);
        });

        container.appendChild(labelElement);
        container.appendChild(selectElement);
    }

    function createCheckboxGroup(container, id, label, options, checkedValues = []) {
        const labelElement = document.createElement('label');
        labelElement.textContent = label;
        container.appendChild(labelElement);

        const checkboxContainer = document.createElement('div');
        checkboxContainer.id = id;
        checkboxContainer.classList.add('checkbox-container');

        options.forEach(option => {
            const checkboxWrapper = document.createElement('div');
            checkboxWrapper.classList.add('checkbox-wrapper');

            const checkboxElement = document.createElement('input');
            checkboxElement.type = 'checkbox';
            checkboxElement.name = `${id}[]`;
            checkboxElement.value = option;
            checkboxElement.id = `checkbox-${option.replace(/\s+/g, '-')}`;
            checkboxElement.disabled = true; // Initially disabled
            if (Array.isArray(checkedValues) && checkedValues.includes(option)) checkboxElement.checked = true;

            const checkboxLabel = document.createElement('label');
            checkboxLabel.textContent = option;
            checkboxLabel.htmlFor = `checkbox-${option.replace(/\s+/g, '-')}`;

            checkboxWrapper.appendChild(checkboxElement);
            checkboxWrapper.appendChild(checkboxLabel);
            checkboxContainer.appendChild(checkboxWrapper);
        });
        container.appendChild(checkboxContainer);
    }
});
</script> 
        
<script>        
    // toggle password functionality
        const togglePassword = document.querySelector('#togglePassword');
        const passwordInput = document.querySelector('#password');

        togglePassword.addEventListener('click', () => {

            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;

            togglePassword.classList.toggle('fa-eye');
            togglePassword.classList.toggle('fa-eye-slash');
        });
</script>
</body>
</html> 